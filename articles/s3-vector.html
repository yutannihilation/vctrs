<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>S3 vectors • vctrs</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/1.7.1/clipboard.min.js" integrity="sha384-cV+rhyOuRHc9Ub/91rihWcGmMmCXDeksTtCihMupQHSsi8GIIRDG0ThDc3HGQFJ3" crossorigin="anonymous"></script><!-- sticky kit --><script src="https://cdnjs.cloudflare.com/ajax/libs/sticky-kit/1.1.3/sticky-kit.min.js" integrity="sha256-c4Rlo1ZozqTPE2RLuvbusY3+SU1pQaJC0TjuhygMipw=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="S3 vectors">
<meta property="og:description" content="">
<meta property="og:image" content="/logo.png">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">vctrs</a>
        <span class="label label-default" data-toggle="tooltip" data-placement="bottom" title="Released package">0.0.0.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/s3-vector.html">S3 vectors</a>
    </li>
    <li>
      <a href="../articles/theory.html">vctrs theory</a>
    </li>
    <li>
      <a href="../articles/vctrs-vs-base.html">vctrs vs base</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/r-lib/vctrs">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>S3 vectors</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/r-lib/vctrs/blob/master/vignettes/s3-vector.Rmd"><code>vignettes/s3-vector.Rmd</code></a></small>
      <div class="hidden name"><code>s3-vector.Rmd</code></div>

    </div>

    
    
<p>This vignette contains tips for creating your own S3 vector class built on top the <code>vctr</code> class provided by vctrs. It focusses on the aspects of making a vector class that every class needs to worry about; you’ll also need to provide methods that actually make the vector useful.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="kw">library</span>(vctrs)</a></code></pre></div>
<div id="my-first-class-percent" class="section level2">
<h2 class="hasAnchor">
<a href="#my-first-class-percent" class="anchor"></a>My first class: <code>percent()</code>
</h2>
<p>In this section, I’ll show you how to make a “percent” class, i.e. a double vector that is multiplied by 100 and suffixed with <code>%</code> when printed. This is a good place to start because it’s the simplest possible S3 class; the only attribute used is <code>class</code>.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" data-line-number="1"><span class="kw">percent</span>(<span class="kw">c</span>(<span class="dv">0</span>, <span class="fl">0.5</span>, <span class="dv">1</span>))</a>
<a class="sourceLine" id="cb2-2" data-line-number="2"><span class="co">#&gt; &lt;percent[3]&gt;</span></a>
<a class="sourceLine" id="cb2-3" data-line-number="3"><span class="co">#&gt; [1]   0%  50% 100%</span></a></code></pre></div>
<div id="low-level-constructor" class="section level3">
<h3 class="hasAnchor">
<a href="#low-level-constructor" class="anchor"></a>Low-level constructor</h3>
<p>All classes should have a low-level constructor called <code>new_class()</code> that checks types (but not values), then calls <code><a href="../reference/new_vctr.html">new_vctr()</a></code>. This function is designed for developers: it should be high performance (i.e. no expensive checks) so it can be called from other functions.</p>
<p>The percent class is very simple, so this only has a single argument, <code>x</code>, which needs to be a double vector.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" data-line-number="1">new_percent &lt;-<span class="st"> </span><span class="cf">function</span>(x) {</a>
<a class="sourceLine" id="cb3-2" data-line-number="2">  <span class="kw">stopifnot</span>(<span class="kw">is.double</span>(x))</a>
<a class="sourceLine" id="cb3-3" data-line-number="3">  <span class="kw"><a href="../reference/new_vctr.html">new_vctr</a></span>(x, <span class="dt">class =</span> <span class="st">"percent"</span>)</a>
<a class="sourceLine" id="cb3-4" data-line-number="4">}</a>
<a class="sourceLine" id="cb3-5" data-line-number="5"></a>
<a class="sourceLine" id="cb3-6" data-line-number="6">x &lt;-<span class="st"> </span><span class="kw">new_percent</span>(<span class="kw">c</span>(<span class="kw">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="dt">length =</span> <span class="dv">4</span>), <span class="ot">NA</span>))</a></code></pre></div>
</div>
<div id="your-first-method-format" class="section level3">
<h3 class="hasAnchor">
<a href="#your-first-method-format" class="anchor"></a>Your first method: <code>format()</code>
</h3>
<p>We can’t yet look at this object:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" data-line-number="1">x</a>
<a class="sourceLine" id="cb4-2" data-line-number="2"><span class="co">#&gt; &lt;percent[5]&gt;</span></a>
<a class="sourceLine" id="cb4-3" data-line-number="3"><span class="co">#&gt; Error: `format.percent()` not implemented</span></a>
<a class="sourceLine" id="cb4-4" data-line-number="4"><span class="co">#&gt; Backtrail:</span></a>
<a class="sourceLine" id="cb4-5" data-line-number="5"><span class="co">#&gt;  ─withCallingHandlers(...)</span></a>
<a class="sourceLine" id="cb4-6" data-line-number="6"><span class="co">#&gt;  ─(function (...) ...</span></a>
<a class="sourceLine" id="cb4-7" data-line-number="7"><span class="co">#&gt;  ─rmarkdown::render(...)</span></a>
<a class="sourceLine" id="cb4-8" data-line-number="8"><span class="co">#&gt;  ─knitr::knit(...)</span></a>
<a class="sourceLine" id="cb4-9" data-line-number="9"><span class="co">#&gt;  ─process_file(text, output)</span></a>
<a class="sourceLine" id="cb4-10" data-line-number="10"><span class="co">#&gt;  ─ ... with 8 more calls</span></a>
<a class="sourceLine" id="cb4-11" data-line-number="11"><span class="co">#&gt;  ─knit_print.default(x, ...)</span></a>
<a class="sourceLine" id="cb4-12" data-line-number="12"><span class="co">#&gt;  ─normal_print(x)</span></a>
<a class="sourceLine" id="cb4-13" data-line-number="13"><span class="co">#&gt;  ─print.vctrs_vctr(x)</span></a>
<a class="sourceLine" id="cb4-14" data-line-number="14"><span class="co">#&gt;  ─format.vctrs_vctr(x)</span></a>
<a class="sourceLine" id="cb4-15" data-line-number="15"><span class="co">#&gt;  ─stop_unimplemented(x, "format")</span></a>
<a class="sourceLine" id="cb4-16" data-line-number="16"></a>
<a class="sourceLine" id="cb4-17" data-line-number="17"><span class="kw">str</span>(x)</a>
<a class="sourceLine" id="cb4-18" data-line-number="18"><span class="co">#&gt; Error: `format.percent()` not implemented</span></a>
<a class="sourceLine" id="cb4-19" data-line-number="19"><span class="co">#&gt; Backtrail:</span></a>
<a class="sourceLine" id="cb4-20" data-line-number="20"><span class="co">#&gt;  ─withCallingHandlers(...)</span></a>
<a class="sourceLine" id="cb4-21" data-line-number="21"><span class="co">#&gt;  ─str.vctrs_vctr(x)</span></a>
<a class="sourceLine" id="cb4-22" data-line-number="22"><span class="co">#&gt;  ─format.vctrs_vctr(x)</span></a>
<a class="sourceLine" id="cb4-23" data-line-number="23"><span class="co">#&gt;  ─stop_unimplemented(x, "format")</span></a></code></pre></div>
<p>Because we need to provide a <code>format()</code> method. This method should return a character vector the same length as <code>x</code>. The easiest way to do this is to rely on one of R’s low-level formatting functions like <code>formatC()</code>:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" data-line-number="1">format.percent &lt;-<span class="st"> </span><span class="cf">function</span>(x, ...) {</a>
<a class="sourceLine" id="cb5-2" data-line-number="2">  out &lt;-<span class="st"> </span><span class="kw">formatC</span>(<span class="kw">signif</span>(x <span class="op">*</span><span class="st"> </span><span class="dv">100</span>, <span class="dv">3</span>))</a>
<a class="sourceLine" id="cb5-3" data-line-number="3">  out[<span class="op">!</span><span class="kw">is.na</span>(x)] &lt;-<span class="st"> </span><span class="kw">paste0</span>(out[<span class="op">!</span><span class="kw">is.na</span>(x)], <span class="st">"%"</span>)</a>
<a class="sourceLine" id="cb5-4" data-line-number="4">  out</a>
<a class="sourceLine" id="cb5-5" data-line-number="5">}</a></code></pre></div>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" data-line-number="1">x</a>
<a class="sourceLine" id="cb6-2" data-line-number="2"><span class="co">#&gt; &lt;percent[5]&gt;</span></a>
<a class="sourceLine" id="cb6-3" data-line-number="3"><span class="co">#&gt; [1] 0%    33.3% 66.7% 100%  NA</span></a></code></pre></div>
<p>The format method is also used by data frames, tibbles, and <code>str()</code>:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" data-line-number="1"><span class="kw">data.frame</span>(x)</a>
<a class="sourceLine" id="cb7-2" data-line-number="2"><span class="co">#&gt;       x</span></a>
<a class="sourceLine" id="cb7-3" data-line-number="3"><span class="co">#&gt; 1    0%</span></a>
<a class="sourceLine" id="cb7-4" data-line-number="4"><span class="co">#&gt; 2 33.3%</span></a>
<a class="sourceLine" id="cb7-5" data-line-number="5"><span class="co">#&gt; 3 66.7%</span></a>
<a class="sourceLine" id="cb7-6" data-line-number="6"><span class="co">#&gt; 4  100%</span></a>
<a class="sourceLine" id="cb7-7" data-line-number="7"><span class="co">#&gt; 5    NA</span></a></code></pre></div>
<p>For optimal display, I recommend also defining an abbreviated type name. This is used in tibbles and <code>str()</code>:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" data-line-number="1">vec_ptype_abbr.percent &lt;-<span class="st"> </span><span class="cf">function</span>(x) {</a>
<a class="sourceLine" id="cb8-2" data-line-number="2">  <span class="st">"pctv"</span></a>
<a class="sourceLine" id="cb8-3" data-line-number="3">}</a>
<a class="sourceLine" id="cb8-4" data-line-number="4"></a>
<a class="sourceLine" id="cb8-5" data-line-number="5">tibble<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/tibble/topics/tibble">tibble</a></span>(x)</a>
<a class="sourceLine" id="cb8-6" data-line-number="6"><span class="co">#&gt; # A tibble: 5 x 1</span></a>
<a class="sourceLine" id="cb8-7" data-line-number="7"><span class="co">#&gt;        x</span></a>
<a class="sourceLine" id="cb8-8" data-line-number="8"><span class="co">#&gt;   &lt;pctv&gt;</span></a>
<a class="sourceLine" id="cb8-9" data-line-number="9"><span class="co">#&gt; 1     0%</span></a>
<a class="sourceLine" id="cb8-10" data-line-number="10"><span class="co">#&gt; 2  33.3%</span></a>
<a class="sourceLine" id="cb8-11" data-line-number="11"><span class="co">#&gt; 3  66.7%</span></a>
<a class="sourceLine" id="cb8-12" data-line-number="12"><span class="co">#&gt; 4   100%</span></a>
<a class="sourceLine" id="cb8-13" data-line-number="13"><span class="co">#&gt; 5     NA</span></a>
<a class="sourceLine" id="cb8-14" data-line-number="14"></a>
<a class="sourceLine" id="cb8-15" data-line-number="15"><span class="kw">str</span>(x)</a>
<a class="sourceLine" id="cb8-16" data-line-number="16"><span class="co">#&gt;  pctv [1:5] 0%, 33.3%, 66.7%, 100%, NA</span></a></code></pre></div>
<p>You can gain greater control over tibble printing by providing a method for <code><a href="http://www.rdocumentation.org/packages/pillar/topics/pillar_shaft">pillar::pillar_shaft()</a></code>. See the details in: <a href="https://tibble.tidyverse.org/articles/extending.html" class="uri">https://tibble.tidyverse.org/articles/extending.html</a>.</p>
</div>
<div id="default-methods" class="section level3">
<h3 class="hasAnchor">
<a href="#default-methods" class="anchor"></a>Default methods</h3>
<p>The vctr base class implements defaults for many common methods so that you don’t have to. It provides default subsetting methods for all underlying vectors, default mathematical operations for numeric vectors, and logical operations for logical vectors.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" data-line-number="1">x[<span class="dv">1</span><span class="op">:</span><span class="dv">2</span>]</a>
<a class="sourceLine" id="cb9-2" data-line-number="2"><span class="co">#&gt; &lt;percent[2]&gt;</span></a>
<a class="sourceLine" id="cb9-3" data-line-number="3"><span class="co">#&gt; [1] 0%    33.3%</span></a>
<a class="sourceLine" id="cb9-4" data-line-number="4"></a>
<a class="sourceLine" id="cb9-5" data-line-number="5">x[[<span class="dv">1</span>]]</a>
<a class="sourceLine" id="cb9-6" data-line-number="6"><span class="co">#&gt; &lt;percent[1]&gt;</span></a>
<a class="sourceLine" id="cb9-7" data-line-number="7"><span class="co">#&gt; [1] 0%</span></a>
<a class="sourceLine" id="cb9-8" data-line-number="8"></a>
<a class="sourceLine" id="cb9-9" data-line-number="9"><span class="op">-</span>x</a>
<a class="sourceLine" id="cb9-10" data-line-number="10"><span class="co">#&gt; &lt;percent[5]&gt;</span></a>
<a class="sourceLine" id="cb9-11" data-line-number="11"><span class="co">#&gt; [1] -0%    -33.3% -66.7% -100%  NA</span></a>
<a class="sourceLine" id="cb9-12" data-line-number="12"></a>
<a class="sourceLine" id="cb9-13" data-line-number="13"><span class="kw">sqrt</span>(x)</a>
<a class="sourceLine" id="cb9-14" data-line-number="14"><span class="co">#&gt; &lt;percent[5]&gt;</span></a>
<a class="sourceLine" id="cb9-15" data-line-number="15"><span class="co">#&gt; [1] 0%    57.7% 81.6% 100%  NA</span></a></code></pre></div>
</div>
<div id="user-friendly-constructor" class="section level3">
<h3 class="hasAnchor">
<a href="#user-friendly-constructor" class="anchor"></a>User-friendly constructor</h3>
<p>Next, implement a user friendly constructor called <code>myclass()</code>. It should carefully check that the input is valid, providing human readable messages if it is not. The user-friendly constructor will typically use <code><a href="../reference/vec_cast.html">vec_cast()</a></code> to helpfully coerce inputs to the correct type.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb10-1" data-line-number="1">percent &lt;-<span class="st"> </span><span class="cf">function</span>(<span class="dt">x =</span> <span class="kw">double</span>()) {</a>
<a class="sourceLine" id="cb10-2" data-line-number="2">  <span class="co"># Check invariants</span></a>
<a class="sourceLine" id="cb10-3" data-line-number="3">  <span class="cf">if</span> (<span class="op">!</span><span class="kw">is.numeric</span>(x)) {</a>
<a class="sourceLine" id="cb10-4" data-line-number="4">    <span class="kw">stop</span>(<span class="st">"Percentages must be numeric"</span>, <span class="dt">call. =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb10-5" data-line-number="5">  }</a>
<a class="sourceLine" id="cb10-6" data-line-number="6"></a>
<a class="sourceLine" id="cb10-7" data-line-number="7">  <span class="co"># Strip attributes and names</span></a>
<a class="sourceLine" id="cb10-8" data-line-number="8">  x &lt;-<span class="st"> </span><span class="kw">as.double</span>(x)</a>
<a class="sourceLine" id="cb10-9" data-line-number="9"></a>
<a class="sourceLine" id="cb10-10" data-line-number="10">  <span class="kw">new_percent</span>(x)</a>
<a class="sourceLine" id="cb10-11" data-line-number="11">}</a></code></pre></div>
<p>Check that user-friendly constructor returns a zero-length vector when called with no arguments:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb11-1" data-line-number="1"><span class="kw">percent</span>()</a>
<a class="sourceLine" id="cb11-2" data-line-number="2"><span class="co">#&gt; &lt;percent[0]&gt;</span></a></code></pre></div>
</div>
<div id="casting" class="section level3">
<h3 class="hasAnchor">
<a href="#casting" class="anchor"></a>Casting</h3>
<p>Next, define possible casts between your vector and existing types. You do this by providing methods for <code><a href="../reference/vec_cast.html">vec_cast()</a></code>. <code><a href="../reference/vec_cast.html">vec_cast()</a></code> is a little unusual because the result depends on the type of both arguments: the input <code>x</code>, and the target type <code>to</code>. Techically, this means that we need <strong><a href="https://en.wikipedia.org/wiki/Double_dispatch">double dispatch</a></strong>. S3 does not natively support double dispatch, but we can implement with a trick: doing single dispatch twice. Here we’ll focus on the practicalities, giving you a recipe to follow for your class. Read <code><a href="../articles/theory.html">vignette("theory")</a></code> to get more details on the theory, and to help you think about what casts you should enable.</p>
<p>First, we create a new generic, and provide a standard set of methods. These are required for every class; you can just copy and paste this block, replacing <code>percent</code> with the name of your class.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb12-1" data-line-number="1">vec_cast.percent &lt;-<span class="st"> </span><span class="cf">function</span>(x, to) <span class="kw">UseMethod</span>(<span class="st">"vec_cast.percent"</span>)</a>
<a class="sourceLine" id="cb12-2" data-line-number="2">vec_cast.percent.default &lt;-<span class="st"> </span><span class="cf">function</span>(x, to) <span class="kw"><a href="../reference/vctrs-conditions.html">stop_incompatible_cast</a></span>(x, to)</a>
<a class="sourceLine" id="cb12-3" data-line-number="3">vec_cast.percent.NULL    &lt;-<span class="st"> </span><span class="cf">function</span>(x, to) x</a>
<a class="sourceLine" id="cb12-4" data-line-number="4">vec_cast.NULL.percent    &lt;-<span class="st"> </span><span class="cf">function</span>(x, to) x</a>
<a class="sourceLine" id="cb12-5" data-line-number="5">vec_cast.percent.percent &lt;-<span class="st"> </span><span class="cf">function</span>(x, to) x</a></code></pre></div>
<p>Next we provide some useful methods to coerce percents back and forth between integers and doubles. We use <code><a href="../reference/vec_cast.html">vec_cast()</a></code> on the underlying vector (<code><a href="../reference/vec_data.html">vec_data()</a></code>) in order to get the nice default behaviour which reports when we lose precision:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb13-1" data-line-number="1">vec_cast.percent.double &lt;-<span class="st"> </span><span class="cf">function</span>(x, to) <span class="kw">percent</span>(x)</a>
<a class="sourceLine" id="cb13-2" data-line-number="2">vec_cast.double.percent &lt;-<span class="st"> </span><span class="cf">function</span>(x, to) <span class="kw"><a href="../reference/vec_data.html">vec_data</a></span>(x)</a>
<a class="sourceLine" id="cb13-3" data-line-number="3"></a>
<a class="sourceLine" id="cb13-4" data-line-number="4"><span class="kw"><a href="../reference/vec_cast.html">vec_cast</a></span>(<span class="fl">0.5</span>, <span class="kw">percent</span>())</a>
<a class="sourceLine" id="cb13-5" data-line-number="5"><span class="co">#&gt; &lt;percent[1]&gt;</span></a>
<a class="sourceLine" id="cb13-6" data-line-number="6"><span class="co">#&gt; [1] 50%</span></a>
<a class="sourceLine" id="cb13-7" data-line-number="7"><span class="kw"><a href="../reference/vec_cast.html">vec_cast</a></span>(<span class="kw">percent</span>(<span class="fl">0.5</span>), <span class="kw">double</span>())</a>
<a class="sourceLine" id="cb13-8" data-line-number="8"><span class="co">#&gt; [1] 0.5</span></a>
<a class="sourceLine" id="cb13-9" data-line-number="9"></a>
<a class="sourceLine" id="cb13-10" data-line-number="10">vec_cast.percent.integer &lt;-<span class="st"> </span><span class="cf">function</span>(x, to) <span class="kw">percent</span>(x)</a>
<a class="sourceLine" id="cb13-11" data-line-number="11">vec_cast.integer.percent &lt;-<span class="st"> </span><span class="cf">function</span>(x, to) <span class="kw"><a href="../reference/vec_cast.html">vec_cast</a></span>(<span class="kw"><a href="../reference/vec_data.html">vec_data</a></span>(x), <span class="kw">integer</span>())</a>
<a class="sourceLine" id="cb13-12" data-line-number="12"></a>
<a class="sourceLine" id="cb13-13" data-line-number="13"><span class="kw"><a href="../reference/vec_cast.html">vec_cast</a></span>(<span class="kw">integer</span>(), <span class="kw">percent</span>(<span class="fl">0.5</span>))</a>
<a class="sourceLine" id="cb13-14" data-line-number="14"><span class="co">#&gt; &lt;percent[0]&gt;</span></a>
<a class="sourceLine" id="cb13-15" data-line-number="15"><span class="kw"><a href="../reference/vec_cast.html">vec_cast</a></span>(<span class="kw">percent</span>(<span class="fl">0.5</span>), <span class="kw">integer</span>())</a>
<a class="sourceLine" id="cb13-16" data-line-number="16"><span class="co">#&gt; Warning: Lossy cast from double to integer</span></a>
<a class="sourceLine" id="cb13-17" data-line-number="17"><span class="co">#&gt; Locations: 1</span></a>
<a class="sourceLine" id="cb13-18" data-line-number="18"><span class="co">#&gt; [1] 0</span></a></code></pre></div>
<p>These methods power <code>[[&lt;-</code> and <code>[&lt;-</code>, because the vctrs default coerces the <code>value</code> to the same type as <code>x</code>.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb14-1" data-line-number="1">x[<span class="dv">1</span>] &lt;-<span class="st"> </span><span class="dv">2</span></a>
<a class="sourceLine" id="cb14-2" data-line-number="2">x</a>
<a class="sourceLine" id="cb14-3" data-line-number="3"><span class="co">#&gt; &lt;percent[5]&gt;</span></a>
<a class="sourceLine" id="cb14-4" data-line-number="4"><span class="co">#&gt; [1] 200%  33.3% 66.7% 100%  NA</span></a>
<a class="sourceLine" id="cb14-5" data-line-number="5"></a>
<a class="sourceLine" id="cb14-6" data-line-number="6">x[[<span class="dv">1</span>]] &lt;-<span class="st"> "x"</span></a>
<a class="sourceLine" id="cb14-7" data-line-number="7"><span class="co">#&gt; Error: Can't cast character to percent</span></a>
<a class="sourceLine" id="cb14-8" data-line-number="8"><span class="co">#&gt; Backtrail:</span></a>
<a class="sourceLine" id="cb14-9" data-line-number="9"><span class="co">#&gt;  ─withCallingHandlers(...)</span></a>
<a class="sourceLine" id="cb14-10" data-line-number="10"><span class="co">#&gt;  ─`[[&lt;-.vctrs_vctr`(`*tmp*`, 1, value = "x")</span></a>
<a class="sourceLine" id="cb14-11" data-line-number="11"><span class="co">#&gt;  ─vec_cast.percent.default(value, x)</span></a>
<a class="sourceLine" id="cb14-12" data-line-number="12"><span class="co">#&gt;  ─stop_incompatible_cast(x, to)</span></a>
<a class="sourceLine" id="cb14-13" data-line-number="13"><span class="co">#&gt;  ─stop_incompatible(...)</span></a></code></pre></div>
</div>
<div id="coercion" class="section level3">
<h3 class="hasAnchor">
<a href="#coercion" class="anchor"></a>Coercion</h3>
<p>Finally, we define methods for <code><a href="../reference/vec_type2.html">vec_type2()</a></code> which describe when it is ok to perform automatic (aka implicit) coercion. Again, <code><a href="../reference/vec_type2.html">vec_type2()</a></code> uses double-dispatch, so we start off with a recipe.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb15-1" data-line-number="1">vec_type2.percent &lt;-<span class="st"> </span><span class="cf">function</span>(x, y) <span class="kw">UseMethod</span>(<span class="st">"vec_cast.percent"</span>)</a>
<a class="sourceLine" id="cb15-2" data-line-number="2">vec_type2.percent.default &lt;-<span class="st"> </span><span class="cf">function</span>(x, y) <span class="kw"><a href="../reference/vctrs-conditions.html">stop_incompatible_type</a></span>(x, y)</a>
<a class="sourceLine" id="cb15-3" data-line-number="3">vec_type2.percent.NULL    &lt;-<span class="st"> </span><span class="cf">function</span>(x, y) <span class="kw">percent</span>()</a>
<a class="sourceLine" id="cb15-4" data-line-number="4">vec_type2.NULL.percent    &lt;-<span class="st"> </span><span class="cf">function</span>(x, y) <span class="kw">percent</span>()</a>
<a class="sourceLine" id="cb15-5" data-line-number="5">vec_type2.percent.percent &lt;-<span class="st"> </span><span class="cf">function</span>(x, y) <span class="kw">percent</span>()</a></code></pre></div>
<p>And then we define methods that say it’s ok to automatically coerce percents to numbers. If you’re unsure about what methods to provide here, err on the side of caution: too many implicit coercions make code hard to understand. See <code><a href="../articles/theory.html">vignette("theory")</a></code> for more details.</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb16-1" data-line-number="1">vec_type2.percent.double &lt;-<span class="st"> </span><span class="cf">function</span>(x, y) <span class="kw">percent</span>()</a>
<a class="sourceLine" id="cb16-2" data-line-number="2">vec_type2.double.percent &lt;-<span class="st"> </span><span class="cf">function</span>(x, y) <span class="kw">percent</span>()</a>
<a class="sourceLine" id="cb16-3" data-line-number="3">vec_type2.percent.integer &lt;-<span class="st"> </span><span class="cf">function</span>(x, y) <span class="kw">percent</span>()</a>
<a class="sourceLine" id="cb16-4" data-line-number="4">vec_type2.integer.percent &lt;-<span class="st"> </span><span class="cf">function</span>(x, y) <span class="kw">percent</span>()</a></code></pre></div>
<p>Implementing casting gives you more methods for free:</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb17-1" data-line-number="1"><span class="kw"><a href="../reference/vec_c.html">vec_c</a></span>(x, <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb17-2" data-line-number="2"><span class="co">#&gt; &lt;percent[6]&gt;</span></a>
<a class="sourceLine" id="cb17-3" data-line-number="3"><span class="co">#&gt; [1] 200%  33.3% 66.7% 100%  NA    100%</span></a>
<a class="sourceLine" id="cb17-4" data-line-number="4"></a>
<a class="sourceLine" id="cb17-5" data-line-number="5">x <span class="op">==</span><span class="st"> </span><span class="dv">1</span></a>
<a class="sourceLine" id="cb17-6" data-line-number="6"><span class="co">#&gt; [1] FALSE FALSE FALSE  TRUE    NA</span></a>
<a class="sourceLine" id="cb17-7" data-line-number="7">x <span class="op">*</span><span class="st"> </span><span class="dv">2</span></a>
<a class="sourceLine" id="cb17-8" data-line-number="8"><span class="co">#&gt; &lt;percent[5]&gt;</span></a>
<a class="sourceLine" id="cb17-9" data-line-number="9"><span class="co">#&gt; [1] 400%  66.7% 133%  200%  NA</span></a></code></pre></div>
<p>Unfortunately, due to the design of the “S3 group generics”, there’s no way to make vctr classes fully compatible with the base S3 classes:</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb18-1" data-line-number="1">x <span class="op">*</span><span class="st"> </span><span class="kw">factor</span>(<span class="st">"x"</span>)</a>
<a class="sourceLine" id="cb18-2" data-line-number="2"><span class="co">#&gt; Warning: Incompatible methods ("Ops.vctrs_vctr", "Ops.factor") for "*"</span></a>
<a class="sourceLine" id="cb18-3" data-line-number="3"><span class="co">#&gt; &lt;percent[5]&gt;</span></a>
<a class="sourceLine" id="cb18-4" data-line-number="4"><span class="co">#&gt; [1] 200%  33.3% 66.7% 100%  NA</span></a>
<a class="sourceLine" id="cb18-5" data-line-number="5"><span class="kw">factor</span>(<span class="st">"x"</span>) <span class="op">*</span><span class="st"> </span>x</a>
<a class="sourceLine" id="cb18-6" data-line-number="6"><span class="co">#&gt; Warning: Incompatible methods ("Ops.factor", "Ops.vctrs_vctr") for "*"</span></a>
<a class="sourceLine" id="cb18-7" data-line-number="7"><span class="co">#&gt; &lt;percent[5]&gt;</span></a>
<a class="sourceLine" id="cb18-8" data-line-number="8"><span class="co">#&gt; [1] 200%  33.3% 66.7% 100%  NA</span></a></code></pre></div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#my-first-class-percent">My first class: <code>percent()</code></a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by <a href="http://hadley.nz">Hadley Wickham</a>.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://pkgdown.r-lib.org/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  

  </body>
</html>
